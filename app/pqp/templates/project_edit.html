<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edit Project — {{ code }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pqp-theme.css') }}">
  <link rel="icon" type="image/png" sizes="48x48"  href="{{ url_for('static', filename='brand/icon_48x48.png') }}">
  <link rel="icon" type="image/png" sizes="72x72"  href="{{ url_for('static', filename='brand/icon_72x72.png') }}">
  <link rel="icon" type="image/png" sizes="96x96"  href="{{ url_for('static', filename='brand/icon_96x96.png') }}">
  <link rel="icon" type="image/png" sizes="144x144" href="{{ url_for('static', filename='brand/icon_144x144.png') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='brand/icon_192x192.png') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='brand/favicon.ico') }}">
  <meta name="theme-color" content="#18A999">
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark qualipro-navbar mb-3">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('pqp.pqp_dashboard') }}">
      <img class="brand-symbol d-inline d-md-none" src="{{ url_for('static', filename='brand/qualipro_symbol.svg') }}" alt="QualiPro">
      <img class="brand-wordmark d-none d-md-inline" src="{{ url_for('static', filename='brand/qualipro_symbol.svg') }}" alt="QualiPro">
      <span class="brand-stack d-none d-md-flex flex-column ms-1">
        <span class="brand-name">QualiPro</span>
        <span class="brand-tagline d-none d-lg-inline">Assuring Project Excellence</span>
      </span>
    </a>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Edit Project — <span class="text-primary">{{ code }}</span></h4>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('pqp.pqp_form_select_by_code') }}">Back to Selector</a>
      <a class="btn btn-primary btn-sm" href="{{ url_for('pqp.pqp_form_by_code', code=code) }}">Open PQP</a>
    </div>
  </div>

  {% if not project %}
    <div class="alert alert-warning">Project {{ code }} not found.</div>
  {% else %}
    <form id="projForm" class="card p-3 shadow-sm">
      <div class="row g-3">
        {% for f in fields %}
          <div class="col-md-6">
            <label class="form-label">{{ f.col }}</label>

            {% if f.readonly %}
              <input class="form-control" value="{{ f.value }}" readonly>
            {% else %}
              <!-- keep mapping to original column -->
              <input type="hidden" name="__orig__{{ f.slug }}" value="{{ f.col }}">

              {% if f.type == 'date' %}
                <input name="{{ f.slug }}" type="date" class="form-control" value="{{ f.value }}">
              {% elif f.type == 'money' %}
                <input name="{{ f.slug }}" type="text" inputmode="decimal"
                       class="form-control text-end qp-money" value="{{ f.value }}">
              {% else %}
                <input name="{{ f.slug }}" type="text" class="form-control" value="{{ f.value }}">
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a class="btn btn-secondary" href="{{ url_for('pqp.pqp_form_select_by_code') }}">Cancel</a>
        <button type="button" class="btn btn-primary" onclick="saveProject()">Save</button>
      </div>
    </form>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const ZAR = new Intl.NumberFormat('en-ZA',{ style:'currency', currency:'ZAR', minimumFractionDigits:2 });

function formatMoneyInputs(container=document){
  container.querySelectorAll('.qp-money').forEach(el=>{
    const raw = (el.value||'').toString();
    if(/[R]\s?[\d]/.test(raw)) return;
    const num = Number(raw.replace(/[^\d.-]/g,''));
    if(!isNaN(num) && raw.trim()!=='') el.value = ZAR.format(num);
  });
}
function sanitizeMoneyInputs(form){
  form.querySelectorAll('.qp-money').forEach(el=>{
    el.dataset.displayValue = el.value;
    el.value = (el.value||'').replace(/[^\d.-]/g,'');
  });
}
function restoreMoneyInputs(form){
  form.querySelectorAll('.qp-money').forEach(el=>{
    if(el.dataset.displayValue) el.value = el.dataset.displayValue;
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  formatMoneyInputs();
  document.querySelectorAll('.qp-money').forEach(el=>{
    el.addEventListener('blur', ()=> formatMoneyInputs());
  });
});

async function saveProject(){
  const form = document.getElementById('projForm');
  sanitizeMoneyInputs(form);
  const fd = new FormData(form);
  try{
    const res = await fetch("{{ url_for('pqp.project_update', code=code) }}", { method:'POST', body: fd });
    const j = await res.json();
    restoreMoneyInputs(form);
    if(!j.ok){ alert('Save failed: ' + (j.error || 'unknown')); return; }
    window.location.href = "{{ url_for('pqp.pqp_form_select_by_code') }}";
  }catch(e){
    restoreMoneyInputs(form);
    console.error(e); alert('Save failed.');
  }
}
</script>

</body>
</html>
