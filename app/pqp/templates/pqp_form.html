{% extends "base.html" %}
{% block title %}PQP Form{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  {# ---------------- SAFE PROJECT CODE / SHORT NAME ---------------- #}
  {% set code  = '' %}
  {% set short = '' %}

  {% if project is defined and project %}
    {# Normalize Code #}
    {% if project is mapping and 'Code' in project and project['Code'] %}
      {% set code = project['Code'] %}
    {% elif project is not mapping and project.code is defined and project.code %}
      {% set code = project.code %}
    {% endif %}

    {# Normalize Short Name/Description #}
    {% if project is mapping and 'Short Name' in project and project['Short Name'] %}
      {% set short = project['Short Name'] %}
    {% elif project is mapping and 'Short Description' in project and project['Short Description'] %}
      {% set short = project['Short Description'] %}
    {% elif project is not mapping and project.short_name is defined and project.short_name %}
      {% set short = project.short_name %}
    {% elif project is not mapping and project.short_desc is defined and project.short_desc %}
      {% set short = project.short_desc %}
    {% endif %}
  {% endif %}
  {# ---------------------------------------------------------------- #}

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      PQP for Project: <span class="text-primary">{{ code }}</span>
      <small class="text-muted">{{ short }}</small>
    </h3>
    <a href="{{ url_for('pqp.pqp_form_select_by_code') }}" class="btn btn-outline-secondary btn-sm">Back to Selector</a>
  </div>

  {# Sections list (kept here so it always renders) #}
  {% set sections = [
    "Project Overview",
    "Project Team",
    "Appointment & Milestones",
    "Planning & Design",
    "Documentation & Tender",
    "Works & Handover",
    "Additional Services",
    "Close-Out & Feedback",
    "Scope Register"
  ] %}

  {# -------------------- HELPER MACROS -------------------- #}
  {% macro cell_value(row, col) -%}
    {%- if row is mapping -%}
      {{ row.get(col, '') }}
    {%- else -%}
      {{ attribute(row, col) | default('') }}
    {%- endif -%}
  {%- endmacro %}

  {% macro row_id_of(row, fallback) -%}
    {%- if row is mapping -%}
      {%- if 'id' in row and row['id'] %}{{ row['id'] }}{% else %}{{ fallback }}{% endif -%}
    {%- else -%}
      {%- if row.id is defined and row.id %}{{ row.id }}{% else %}{{ fallback }}{% endif -%}
    {%- endif -%}
  {%- endmacro %}
  {# ------------------------------------------------------ #}

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="pqpTabs" role="tablist">
    {% for sec in sections %}
      {% set i = loop.index0 %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}"
                id="tab-{{ i }}"
                data-bs-toggle="tab"
                data-bs-target="#section-{{ i }}"
                type="button"
                role="tab">
          {{ sec }}
        </button>
      </li>
    {% endfor %}
    <!-- Extra tabs -->
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-reports" data-bs-toggle="tab" data-bs-target="#section-reports" type="button" role="tab">
        Reports
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-importexport" data-bs-toggle="tab" data-bs-target="#section-importexport" type="button" role="tab">
        Import / Export
      </button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content border border-top-0 p-3 bg-white" id="pqpTabContent">
    {% for sec in sections %}
      {% set i = loop.index0 %}

      {# ------ SAFE DEFAULTS PER SECTION ------ #}
      {% set cols = [] %}
      {% if section_columns is defined and section_columns|length > i and section_columns[i] %}
        {% set cols = section_columns[i] %}
      {% else %}
        {% set cols = ['id','Title','Description','Status','Notes'] %}
      {% endif %}

      {% set rows = [] %}
      {% if section_data is defined and section_data|length > i and section_data[i] %}
        {% set rows = section_data[i] %}
      {% else %}
        {% set rows = [] %}
      {% endif %}
      {# -------------------------------------- #}

      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="section-{{ i }}"
           role="tabpanel"
           aria-labelledby="tab-{{ i }}">

        <!-- Actions -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">{{ sec }}</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#addModal-{{ i }}">Add New</button>

            <!-- Optional per‑section import (simple hook) -->
            <button class="btn btn-primary btn-sm"
                    onclick="document.getElementById('importFile-{{ i }}').click();">
              Import
            </button>
            <input type="file"
                   id="importFile-{{ i }}"
                   class="d-none"
                   data-import-url="{{ url_for('pqp.pqp_section_import', section_idx=i, code=code) }}"
                   onchange="handleImport(this)">
          </div>
        </div>

        <!-- Data table -->
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle qp-table">
            <thead class="table-light">
              <tr>
                {% for col in cols %}
                  <th>{{ col }}</th>
                {% endfor %}
                <th style="width: 110px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if rows and rows|length > 0 %}
                {% for row in rows %}
                  {% set rid = row_id_of(row, loop.index) %}
                  <tr>
                    {% for col in cols %}
                      <td>{{ cell_value(row, col) }}</td>
                    {% endfor %}
                    <td>
                      <button class="btn btn-warning btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#editModal-{{ i }}-{{ rid }}">
                        Edit
                      </button>
                    </td>
                  </tr>

                  <!-- Edit Modal -->
                  <div class="modal fade" id="editModal-{{ i }}-{{ rid }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <form method="POST" action="{{ url_for('pqp.pqp_section_save', section_idx=i, code=code) }}">
                          <div class="modal-header">
                            <h5 class="modal-title">Edit — {{ sec }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <input type="hidden" name="id" value="{{ rid }}">
                            {% for col in cols %}
                              {% if col != 'id' %}
                                <div class="mb-3">
                                  <label class="form-label">{{ col }}</label>
                                  <input type="text" class="form-control" name="{{ col }}" value="{{ cell_value(row, col) }}">
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{{ cols|length + 1 }}" class="text-center text-muted">No rows yet.</td>
                </tr>
              {% endif %}
            </tbody>

          </table>
        </div>

        <!-- Add Modal -->
        <div class="modal fade" id="addModal-{{ i }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="POST" action="{{ url_for('pqp.pqp_section_save', section_idx=i, code=code) }}">
                <div class="modal-header">
                  <h5 class="modal-title">Add New — {{ sec }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  {% for col in cols %}
                    {% if col != 'id' %}
                      <div class="mb-3">
                        <label class="form-label">{{ col }}</label>
                        <input type="text" class="form-control" name="{{ col }}">
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Add</button>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
    {% endfor %}

    <!-- Reports Pane -->
    <div class="tab-pane fade" id="section-reports" role="tabpanel" aria-labelledby="tab-reports">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary" href="{{ url_for('pqp.pqp_summary_html', code=code) }}" target="_blank">
            Open PQP Summary (HTML)
          </a>
          <a class="btn btn-outline-success" href="{{ url_for('pqp.pqp_export_zip_csv', code=code) }}">
            Export All Sections (CSV .zip)
          </a>
          <button class="btn btn-outline-secondary" disabled title="Coming soon">Export to Excel (XLSX)</button>
          <button class="btn btn-outline-secondary" disabled title="Coming soon">Export Dashboard to PDF</button>
        </div>
      </div>
      <p class="text-muted">Tip: open the HTML summary and use your browser’s <em>Print → Save as PDF</em>.</p>
    </div>

    <!-- Import/Export Pane -->
    <div class="tab-pane fade" id="section-importexport" role="tabpanel" aria-labelledby="tab-importexport">
      <div class="row g-3">
        <!-- Left: CSV templates -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header fw-bold">Download CSV Templates</div>
            <div class="card-body">
              <div class="list-group">
                {% for sec in sections %}
                  <a class="list-group-item list-group-item-action"
                    href="{{ url_for('pqp.pqp_template_csv', section_idx=loop.index0) }}">
                    {{ loop.index }}. {{ sec }}
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Right: CSV bulk import -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header fw-bold">Bulk Import (CSV)</div>
            <div class="card-body">
              <form class="row g-2" id="bulkImportForm">
                <div class="col-12">
                  <label class="form-label">Section</label>
                  <select class="form-select" id="bulkSection">
                    {% for sec in sections %}
                      <option value="{{ loop.index0 }}">{{ loop.index }}. {{ sec }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">CSV File</label>
                  <input type="file" id="bulkFile" class="form-control" accept=".csv">
                </div>
                <div class="col-12 d-flex gap-2">
                  <button type="button" class="btn btn-outline-primary" onclick="bulkPreview()">Preview</button>
                  <button type="button" class="btn btn-success" onclick="bulkCommit()">Commit</button>
                </div>
              </form>
              <pre id="bulkLog" class="small mt-3 bg-light p-2 border rounded" style="max-height:280px;overflow:auto;"></pre>
            </div>
          </div>
        </div>

        <!-- Full-width: AI Bulk Import (.xlsx) -->
        <div class="col-12">
          <div class="card h-100">
            <div class="card-header fw-bold">AI Bulk Import (.xlsx)</div>
            <div class="card-body">
              <p class="text-muted mb-2">
                Select one or more PQP workbooks to preview. Nothing is written until you press <b>Commit</b>.
              </p>

              <div class="d-flex flex-wrap gap-2 mb-2">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('aiFiles').click();">
                  Choose Workbooks
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="PQP_AI.previewSelected()">Preview</button>
                <button type="button" class="btn btn-success" onclick="PQP_AI.commitAll()">Commit</button>
              </div>

              <input id="aiFiles" type="file" accept=".xlsx,.xlsm" multiple class="form-control mb-2">

              <div id="aiPreview" class="mt-3 small"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div> <!-- /tab-content -->

</div> <!-- /container -->
{% endblock %}

{% block scripts %}
<!-- Keep active tab between reloads -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var active = localStorage.getItem("activePqpTab");
    if (active) {
      var trigger = document.querySelector('#pqpTabs button[data-bs-target="' + active + '"]');
      if (trigger) new bootstrap.Tab(trigger).show();
    }
    document.querySelectorAll('#pqpTabs button[data-bs-toggle="tab"]').forEach(function (btn) {
      btn.addEventListener('shown.bs.tab', function (e) {
        localStorage.setItem("activePqpTab", e.target.getAttribute("data-bs-target"));
      });
    });
  });

  // Simple per‑section Import handler (posts to pqp_section_import)
  function handleImport(inputEl) {
    if (!inputEl || !inputEl.files || !inputEl.files[0]) return;
    var url = inputEl.dataset.importUrl;
    var fd = new FormData();
    fd.append('file', inputEl.files[0]);

    fetch(url, { method: 'POST', body: fd })
      .then(r => r.json())
      .then(data => {
        alert('Import preview:\n' + JSON.stringify(data, null, 2));
        inputEl.value = ''; // reset
      })
      .catch(err => {
        console.error(err);
        alert('Import failed. See console for details.');
        inputEl.value = '';
      });
  }

  // Bulk Import (Preview & Commit) – CSV
  function _bulkFetch(url) {
    const sec = document.getElementById('bulkSection').value;
    const fileInput = document.getElementById('bulkFile');
    const log = document.getElementById('bulkLog');
    if (!fileInput.files || !fileInput.files[0]) {
      alert('Choose a CSV first.');
      return;
    }
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);

    fetch(url.replace('__SEC__', sec), { method: 'POST', body: fd })
      .then(r => r.json())
      .then(j => { log.textContent = JSON.stringify(j, null, 2); })
      .catch(e => { log.textContent = String(e); });
  }
  function bulkPreview() {
    const sec = document.getElementById('bulkSection').value;
    const base = '{{ url_for("pqp.pqp_import_preview", code=code, section_idx=0) }}';
    const finalUrl = base.replace('/0/preview', '/' + sec + '/preview');
    _bulkFetch(finalUrl);
  }
  function bulkCommit() {
    if (!confirm('Commit import into the database?')) return;
    const sec = document.getElementById('bulkSection').value;
    const base = '{{ url_for("pqp.pqp_import_commit", code=code, section_idx=0) }}';
    const finalUrl = base.replace('/0/commit', '/' + sec + '/commit');
    _bulkFetch(finalUrl);
  }

  // Configure endpoints for the AI importer (uses your routes)
  window.PQP_AI_ENDPOINTS = {
    preview: "{{ url_for('pqp.pqp_ai_import_preview') }}",
    commit:  "{{ url_for('pqp.pqp_ai_import_commit') }}"
  };
</script>

<!-- Load the AI importer driver ONCE -->
<script src="{{ url_for('static', filename='js/pqp_ai.js') }}"></script>
{% endblock %}
