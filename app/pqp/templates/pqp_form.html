{% extends "base.html" %}
{% block title %}PQP Form{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  {# ---------------- SAFE PROJECT CODE / SHORT NAME ---------------- #}
  {% set code  = '' %}
  {% set short = '' %}

  {% if project is defined and project %}
    {% if project is mapping and 'Code' in project and project['Code'] %}
      {% set code = project['Code'] %}
    {% elif project is not mapping and project.code is defined and project.code %}
      {% set code = project.code %}
    {% endif %}

    {% if project is mapping and 'Short Name' in project and project['Short Name'] %}
      {% set short = project['Short Name'] %}
    {% elif project is mapping and 'Short Description' in project and project['Short Description'] %}
      {% set short = project['Short Description'] %}
    {% elif project is not mapping and project.short_name is defined and project.short_name %}
      {% set short = project.short_name %}
    {% elif project is not mapping and project.short_desc is defined and project.short_desc %}
      {% set short = project.short_desc %}
    {% endif %}
  {% endif %}
  {# ---------------------------------------------------------------- #}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      PQP for Project: <span class="text-primary">{{ code }}</span>
      <small class="text-muted">{{ short }}</small>
    </h3>
    <a href="{{ url_for('pqp.pqp_form_select_by_code') }}" class="btn btn-outline-secondary btn-sm">Back to Selector</a>
  </div>

  {# Keep these defined (empty-safe) so partials never explode #}
  {% set section_columns = section_columns if section_columns is defined else [] %}
  {% set section_data    = section_data    if section_data    is defined else [] %}

  <ul class="nav nav-tabs" id="pqpTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sec1" type="button">Project Overview</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec2" type="button">Project Team</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec3" type="button">Appointment & Milestones</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec4" type="button">Planning & Design</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec5" type="button">Documentation & Tender</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec6" type="button">Works & Handover</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec7" type="button">Additional Services</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec8" type="button">Close-Out & Feedback</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec9" type="button">Scope Register</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#sec10" type="button">Risk Register</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#secReports" type="button">Reports</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#secIO" type="button">Import / Export</button></li>
  </ul>

  <div class="tab-content border border-top-0 p-3 bg-white">

    <!-- 1. Project Overview -->
    <div class="tab-pane fade show active" id="sec1">
      {% set _cols = section_columns[0] if section_columns|length>0 and section_columns[0] else [] %}
      {% set _rows = section_data[0]    if section_data|length>0    and section_data[0]    else [] %}
      {% include "pqp_form_sections/_grid.html" with context %}
    </div>

    <!-- 2. Project Team (kept simple, still renders when empty) -->
    <div class="tab-pane fade" id="sec2">
      {% set _cols = section_columns[1] if section_columns|length>1 and section_columns[1] else [] %}
      {% set _rows = section_data[1]    if section_data|length>1    and section_data[1]    else [] %}
      {% include "pqp_form_sections/_grid.html" with context %}
    </div>

    <!-- 3. Appointment & Milestones (3.1 / 3.2 / 3.3) -->
    <div class="tab-pane fade" id="sec3">
      {% include "pqp_form_sections/03_appointment.html" %}
    </div>

    <!-- 4. Planning & Design (4.1 / 4.2) -->
    <div class="tab-pane fade" id="sec4">
      {% include "pqp_form_sections/04_planning_design.html" %}
    </div>

    <!-- 5. Documentation & Tender (5.1 / 5.2) -->
    <div class="tab-pane fade" id="sec5">
      {% include "pqp_form_sections/05_documentation.html" %}
    </div>

    <!-- 6. Works & Handover (6.1 / 6.2 / 6.3) -->
    <div class="tab-pane fade" id="sec6">
      {% include "pqp_form_sections/06_works_handover.html" %}
    </div>

    <!-- 7. Additional Services (7.1 / 7.2) -->
    <div class="tab-pane fade" id="sec7">
      {% include "pqp_form_sections/07_additional_services.html" %}
    </div>

    <!-- 8. Close-Out & Feedback (still a simple panel, renders empty safely) -->
    <div class="tab-pane fade" id="sec8">
      {% set _cols = section_columns[7] if section_columns|length>7 and section_columns[7] else [] %}
      {% set _rows = section_data[7]    if section_data|length>7    and section_data[7]    else [] %}
      {% include "pqp_form_sections/_grid.html" with context %}
    </div>

    <!-- 9. Scope Register (9.1 / 9.2) -->
    <div class="tab-pane fade" id="sec9">
      {% include "pqp_form_sections/09_scope_register.html" %}
    </div>

    <!-- 10. Risk Register (single grid) -->
    <div class="tab-pane fade" id="sec10">
      {% include "pqp_form_sections/10_risk_register.html" %}
    </div>

    <!-- Reports -->
    <div class="tab-pane fade" id="secReports">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2">
          <a class="btn btn-outline-primary" href="{{ url_for('pqp.pqp_summary_html', code=code) }}" target="_blank">Open PQP Summary (HTML)</a>
          <a class="btn btn-outline-success" href="{{ url_for('pqp.pqp_export_zip_csv', code=code) }}">Export All Sections (CSV .zip)</a>
          <button class="btn btn-outline-secondary" disabled title="Coming soon">Export to Excel (XLSX)</button>
          <button class="btn btn-outline-secondary" disabled title="Coming soon">Export Dashboard to PDF</button>
        </div>
      </div>
      <p class="text-muted">Tip: Open the HTML summary and use your browser’s <em>Print → Save as PDF</em>.</p>
    </div>

    <!-- Import / Export -->
    <div class="tab-pane fade" id="secIO">
      {% include "pqp_form_sections/_import_export_panel.html" ignore missing %}
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Keep active tab
  document.addEventListener("DOMContentLoaded", function () {
    var active = localStorage.getItem("activePqpTab");
    if (active) {
      var trigger = document.querySelector('#pqpTabs [data-bs-target="'+active+'"]');
      if (trigger) new bootstrap.Tab(trigger).show();
    }
    document.querySelectorAll('#pqpTabs [data-bs-toggle="tab"]').forEach(function (btn) {
      btn.addEventListener('shown.bs.tab', function (e) {
        localStorage.setItem("activePqpTab", e.target.getAttribute("data-bs-target"));
      });
    });
  });

  // Toggle "Make Editable" – purely visual scaffold
  window.togglePanelEditable = function(btn){
    var wrap = btn.closest('.pqp-panel');
    if (!wrap) return;
    wrap.classList.toggle('is-editing');
    btn.textContent = wrap.classList.contains('is-editing') ? 'Stop Editing' : 'Make Editable';
  };
</script>
{% endblock %}
